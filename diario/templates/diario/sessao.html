{% extends 'diario/base.html' %}
{% load markdownify %}
{% load static %}
{% block head %}
    <link href="{% static 'diario/diario_de_bordo.css' %}" rel="stylesheet">
    <script src="{% static 'diario/js/diario_de_bordo.js' %}"></script>
{% endblock %}

{% block script %}
    document.addEventListener("DOMContentLoaded", function () {
    document.querySelectorAll(".ee button").forEach((button) => {
    button.onclick = () => {
    parte_id = button.dataset.parte;
    fetch("/diario/parte/" + parte_id)
    .then((response) => response.text())
    .then((data) => {
    const div = document.querySelector("div#exercicio");
    div.innerHTML = data;
    nav = document.querySelector('#navegacao');
    const string = "Sessão {{ sessaoGrupo.sessao.numeroSessao }} > Fase";
    /* NN: NAO ESTÁ A FUNCIONAR PORQUE PARTE.FASE SÓ VEM DA VIEW DA PARTE, E AQUI ESTÁ NA SESSAO */
    /* ISTO É USADO PARA FAZER O BREADCRUMB, VER MAIS TARDE */
    /*const fase = {{ parte.fase }};
    if (fase == 'I') {
    string += 'Inicial';
    }
    if (fase == 'D') {
    string += 'Desenvolvimento';
    }
    if (fase == 'F') {
    string += 'Final';
    }*/
    nav.innerHTML = string;
    })
    .then((data) => {
    const div = document.querySelector("div#exercicio");
    if (div.dataset.estado != "ver") {
    function startTimer(duration, display) {
    setInterval(function () {
    duration_minutes = Math.trunc(duration / 60);
    max = display.getAttribute('aria-valuemax')
    display.innerHTML = duration_minutes + "m";
    perc = calcula_percentagem(duration_minutes, max)
    display.style.width = perc+'%';
    duration++;
    }, 1000);
    }
    display = document.querySelector("#timer"); // selecionando o timer
    var duration = parseInt(display.innerHTML, 10) * 60; // Converter para segundos  -  {{ part.duracao }};
    console.log("duration = ", duration);
    startTimer(duration, display); // iniciando o timer
    }
    });
    };
    });
    });
{% endblock %}

{% block style %}

{% endblock %}

{% block main %}
    {% load markdownify %}
    <!--Esquerda-->
    <div class="card esquerda" style="width:100%; border-color:white;">
        <div class="card-body">
            <div id="exercicio" data-estado="{{ estado }}">
                <div class="titulo" style="padding-top: 1.25rem;margin-top: 5px;">
                    <p class="text-primary m-0 fw-bold">
                        {{ sessaoGrupo.grupo }} - Sessão
                        {{ sessaoGrupo.sessao.numeroSessao }}{% if sessaoGrupo.grupo.programa == "CARE" %}:
                            {{ sessaoGrupo.sessao.nome }}{% endif %}
                    </p>
                    <div>
                        <form action="{% url 'diario:group_sessions' sessaoGrupo.grupo.id %}">
                            <button type="submit" class="btn btn-outline-primary" style="width: 150px">
                                Sessões
                            </button>
                        </form>
                    </div>
                </div>
                <br>
                <br>
                <div style="width:25%" class="esquerda">
                    <h5 class="text-primary m-0 fw-bold">
                        Duração
                        <span class=" m-6 fw-normal text-muted">
                        {{ tempo_total_partes }} minutos
                    </span>
                    </h5>
                    {% if tempo_total_partes_grupo > tempo_total_partes %}
                        <div style="width:100%; margin-top: 5px;" class="progress">
                            <div id="timer" class="progress-bar" role="progressbar"
                                 style="width: {{ tempo_total_partes_grupo }}%; background-color: #dc3545;"
                                 aria-valuenow="{{ tempo_total_partes_grupo }}" aria-valuemin="0"
                                 aria-valuemax="{{ tempo_total_partes }}">
                                {{ tempo_total_partes_grupo }}m
                            </div>
                        </div>
                    {% else %}
                        <div style="width:100%; margin-top: 5px;" class="progress">
                            <div id="timer" class="progress-bar" role="progressbar"
                                 style="width: {{ tempo_total_partes_grupo }}%;"
                                 aria-valuenow="{{ tempo_total_partes_grupo }}" aria-valuemin="0"
                                 aria-valuemax="{{ tempo_total_partes }}">
                                {{ tempo_total_partes_grupo }}m
                            </div>
                        </div>
                    {% endif %}
                </div>

                <br>

                {% if sessaoGrupo.grupo.programa == "CARE" %}
                    <h5 class="text-primary m-0 fw-bold">
                        Tema
                    </h5>
                    {{ sessaoGrupo.sessao.tema | markdownify }}
                {% endif %}
                <h5 class="text-primary m-0 fw-bold">
                    Planificação da Sessão </h5>
                <br>
                <div style=" border: 1px solid #4EB4BE; padding:10px;border-radius:10px; ">
                    <table class="table table-hover ee">
                        <thead class="table-light">
                        <tr>
                            {% if sessaoGrupo.grupo.programa ==  'CARE' %}
                                <th scope="col">Fase</th>
                                <th scope="col">Objetivo</th>
                            {% elif sessaoGrupo.grupo.programa ==  'COG' %}
                                <th scope="col">Domínio</th>
                                <th scope="col">Atividades</th>
                            {% endif %}
                            {% if grupos_permissoes.exists %}
                                <th scope="col" style="text-align:center;">Estado</th>
                                <th scope="col" style="text-align:center;">Duração</th>
                            {% endif %}
                            <th scope="col"></th>
                        </tr>
                        </thead>
                        <tbody class="table-group-divider">
                        {% for parte_do_grupo in partesGrupo %}
                            <tr>
                                {% if sessaoGrupo.grupo.programa == "CARE" %}
                                    <td>
                                        {% if parte_do_grupo.parte.fase == 'I' %}
                                            Inicial
                                        {% endif %}
                                        {% if parte_do_grupo.parte.fase == 'D' %}
                                            Desenvolvimento
                                        {% endif %}
                                        {% if parte_do_grupo.parte.fase == 'F' %}
                                            Final
                                        {% endif %}
                                    </td>
                                    <td>
                                        {{ parte_do_grupo.parte.objetivo }}
                                    </td>
                                {% elif sessaoGrupo.grupo.programa == "COG" %}
                                    <td>
                                        {{ parte_do_grupo.exercicio.dominio }}
                                    </td>
                                    <td>
                                        {{ parte_do_grupo.exercicio.descricao | markdownify }}
                                    </td>
                                {% endif %}
                                {% if grupos_permissoes.exists %}
                                    <td style="text-align: center;">
                                        {% if parte_do_grupo.concluido == True %}
                                            <i class="fa fa-check" aria-hidden="true"
                                               style="color: #008000; font-size:27px;"></i>
                                        {% else %}
                                            <i class="fa fa-times" aria-hidden="true"
                                               style="color: #ff0000; font-size:27px;"></i>
                                        {% endif %}
                                    </td>
                                {% endif %}
                                {% if grupos_permissoes.exists %}
                                    <td style="text-align: center;">
                                        {% if parte_do_grupo.duracao != None %}
                                            {% if sessaoGrupo.grupo.programa == "CARE" %}
                                                {{ parte_do_grupo.duracao_em_horas_minutos }} -
                                                {{ parte_do_grupo.parte.duracao }} min
                                            {% elif sessaoGrupo.grupo.programa == "COG" %}
                                                {{ parte_do_grupo.duracao_em_horas_minutos }} -
                                                {{ parte_do_grupo.exercicio.duracao }} min
                                            {% endif %}

                                        {% endif %}
                                    </td>
                                {% endif %}
                                <td>
                                    {% if parte_do_grupo.inicio == None and pode_iniciar and grupos_permissoes.exists %}
                                        {% if parte_do_grupo.parte.id == proxima_parte or parte_do_grupo.exercicio.id == proxima_parte %}
                                            <button type="button" class="btn btn-primary iniciar btn-sessao"
                                                    {% if sessaoGrupo.grupo.programa == "CARE" %}
                                                    data-parte="{{ parte_do_grupo.parte.id }}/{{ sessaoGrupo.id }}/iniciar/{{ proxima_parte }}"
                                                        >
                                                    {% elif sessaoGrupo.grupo.programa == "COG" %}
                                                        data-parte="{{ parte_do_grupo.exercicio.id }}/
                                                        {{ sessaoGrupo.id }}/iniciar/{{ proxima_parte }}">
                                                    {% endif %}
                                            Iniciar
                                            </button>
                                        {% endif %}
                                    {% elif  parte_do_grupo.inicio != None and grupos_permissoes.exists %}
                                        {% if parte_do_grupo.parte.id == proxima_parte or parte_do_grupo.exercicio.id == proxima_parte %}
                                            <button type="button" class="btn btn-primary continuar btn-sessao"
                                                    {% if sessaoGrupo.grupo.programa == "CARE" %}
                                                    data-parte="{{ parte_do_grupo.parte.id }}/{{ sessaoGrupo.id }}/continuar/{{ proxima_parte }}"
                                                        >
                                                    {% elif sessaoGrupo.grupo.programa == "COG" %}
                                                        data-parte="{{ parte_do_grupo.exercicio.id }}/
                                                        {{ sessaoGrupo.id }}/continuar/{{ proxima_parte }}">
                                                    {% endif %}
                                            Continuar
                                            </button>
                                        {% endif %}
                                    {% elif grupos_permissoes.exists %}
                                        <button type="button" class="btn btn-outline-secondary ver btn-sessao"
                                                {% if sessaoGrupo.grupo.programa == "CARE" %}
                                                data-parte="{{ parte_do_grupo.parte.id }}/{{ sessaoGrupo.id }}/ver/{{ proxima_parte }}"
                                                    >
                                                {% elif sessaoGrupo.grupo.programa == "COG" %}
                                                    data-parte="{{ parte_do_grupo.exercicio.id }}/{{ sessaoGrupo.id }}
                                                    /ver/{{ proxima_parte }}">
                                                {% endif %}
                                        Ver
                                        </button>
                                    {% endif %}

                                </td>
                            </tr>
                        {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            {% if sessaoGrupo.id == proxima_sessao %}
                <div class="flex-buttons">
                    <form action="{% url 'diario:finalizar_sessao' grupo.id sessaoGrupo.id %}" method="POST">
                        {% csrf_token %}
                        <button class="btn btn-primary" style="margin:10px">Terminar Sessão</button>
                    </form>
                </div>
            {% endif %}
        </div>
    </div>

    <!--Direita-->
    <style>
        /* Styling for the side panel container */
        #side-panel-container {
            position: fixed;
            top: 0;
            right: -50%; /* Initially hidden */
            width: 50%;
            height: 100%;
            background-color: #fff;
            transition: right 0.3s ease-in-out;
            z-index: 9999;
            padding: 15px;
        }

        /* Styling for the open panel button */
        #open-panel-btn {
            position: fixed;
            top: 50%;
            right: -20px;
            z-index: 999;
            transform: translateY(-50%) scale(1.2);
            background-color: #fff;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
            cursor: pointer;
            /*transition: right 0.3s ease-in-out;*/
        }

        /* Styling for the arrow icon */
        #open-panel-btn i {
            transition: transform 0.3s ease-in-out;
            margin-right: 20px;
        }

        /* Styling for the arrow animation */
        #open-panel-btn:hover i {
            transform: translateX(-5px) scale(1.2);
        }
    </style>


    <div id="direita" class="card" style="width: 100%; height: 100%; padding:15px; border-color: white; display: none">
        <div id="side-panel-container">

            <div class="card-body" id="diario-de-bordo">
                {% if grupos_permissoes.exists %}
                    <!-- Participantes -->
                    <div class="participantes diario">
                        {% for participante in participantes %}
                            <button type="button" class="btn btn-primary" data-participante="{{ participante.id }}"
                                    data-sessaogrupo="{{ sessaoGrupo.id }}">{{ participante.info_sensivel.nome }}
                            </button>
                        {% endfor %}
                    </div>
                    <div>
                        <!-- Grupo -->
                        <div class="grupo">
                            <button id="botao-grupo" type="button" class="btn btn-primary"
                                    data-idgrupo="{{ sessaoGrupo.id }}"
                                    style="width:100%; margin-top: 10px">Grupo
                            </button>
                        </div>
                        <!--class="btn btn-primary" -->
                        <!-- Parte de Baixo da informacao-->
                        <div class="diario">
                            <button class="menu" data-menu="informacoes">Informações
                            </button>
                            <button class="menu" data-menu="presencas">Presenças
                            </button>
                            {% if sessaoGrupo.grupo.programa == 'CARE' %}
                                <button class="menu" data-menu="respostas" hidden>Respostas
                                </button>
                            {% else %}
                                <button class="menu" data-menu="respostas">Respostas
                                </button>
                            {% endif %}
                            <button class="menu" data-menu="notas">Notas
                            </button>
                            <button class="menu" data-menu="partilhas" style="color:white;">Partilhas
                            </button>
                            <div class="info">
                            </div>
                        </div>
                    </div>
                {% else %}
                    <div class="diario">
                        <button id="participante_notas" class="menu" data-menu="notas"
                                data-participante="{{ cuidador.id }}"
                                data-sessaogrupo="{{ sessaoGrupo.id }}">Notas
                        </button>
                        <button id="participante_partilhas" class="menu" data-menu="partilhas"
                                style="color:white;" data-participante="{{ cuidador.id }}"
                                data-sessaogrupo="{{ sessaoGrupo.id }}">Partilhas
                        </button>
                        <div class="info">
                        </div>
                    </div>
                    <div>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>

    <div id="open-panel-btn" onclick="togglePopoutPanel()">
        <i class="fa fa-chevron-left" style="font-size: 25px; right: -1%; padding-left: 0%;"></i>
    </div>

    <script>
        function togglePopoutPanel() {
            const sidePanelContainer = document.getElementById('side-panel-container');
            const openPanelButton = document.getElementById('open-panel-btn');
            var button = document.getElementById('open-panel-btn');
            mostraDiarioBordo()

            if (sidePanelContainer.style.right === '0%') {
                // Close the panel
                sidePanelContainer.style.right = '-50%';
                openPanelButton.style.right = '-1%';
                button.style.transform = 'rotate(0deg) scale(1.2)';
                button.style.paddingLeft = '0%';
            } else {
                // Open the panel
                sidePanelContainer.style.right = '0%';
                openPanelButton.style.right = '49%'; // Adjust this value to match the width of the side panel
                button.style.transform = 'rotate(180deg) scale(1.2)';
                button.style.paddingLeft = '1.9%';
            }
        }
    </script>
{% endblock %}
